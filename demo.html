<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>CHRocodileå¹²æ¶‰å¼æ„Ÿæ¸¬å™¨åŸç†Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f2f5;
            font-family: "Microsoft JhengHei", Arial, sans-serif;
        }
        .container {
            display: flex;
            flex-direction: row;
            gap: 24px;
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            align-items: flex-start;
        }
        .main-content { flex: 1; text-align: center; min-width: 0; }
        .settings-panel {
            flex-shrink: 0;
            width: 140px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: width 0.25s ease, padding 0.25s ease;
        }
        .settings-panel.collapsed {
            width: 30px;
            padding: 12px 8px;
            overflow: hidden;
        }
        .settings-panel.collapsed .panel-content { display: none; }
        .settings-panel.collapsed .panel-header h3 { display: none; }
        .settings-panel .toggle-btn {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 4px;
            width: 28px;
            height: 28px;
            padding: 4px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: background 0.2s;
        }
        .settings-panel .toggle-btn:hover { background: #e9ecef; }
        .settings-panel .toggle-btn span {
            display: block;
            width: 100%;
            height: 2px;
            background: #495057;
            border-radius: 1px;
        }
        .settings-panel .panel-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        .settings-panel.collapsed .panel-header { margin-bottom: 0; }
        .settings-panel h3 { margin: 0; font-size: 14px; color: #495057; flex: 1; }
        .settings-panel .panel-content { transition: opacity 0.2s; }
        .settings-panel label { display: block; font-size: 12px; color: #6c757d; margin-bottom: 4px; }
        .settings-panel input,
        .settings-panel select {
            width: 100%;
            padding: 6px 8px;
            margin-bottom: 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 13px;
            box-sizing: border-box;
        }
        h2 { color: #333; margin-bottom: 10px; }
        p { color: #666; font-size: 14px; margin-bottom: 20px; }
        canvas {
            border: 1px solid #eee;
            border-radius: 4px;
            cursor: grab;
        }
        canvas:active { cursor: grabbing; }
        .instructions {
            margin-top: 15px;
            padding: 10px;
            background: #eef7ff;
            border-radius: 6px;
            font-size: 13px;
            color: #0056b3;
        }
    </style>
</head>
<body>

<div class="container">
    <aside class="settings-panel collapsed" id="settings-panel">
        <div class="panel-header">
            <button class="toggle-btn" id="toggle-settings" title="å±•é–‹/æ”¶åˆè¨­å®š" data-i18n-title="toggleSettings">
                <span></span><span></span><span></span>
            </button>
            <h3>è¨­å®š</h3>
        </div>
        <div class="panel-content">
            <label for="input-lang">èªè¨€</label>
            <select id="input-lang">
                <option value="auto">è‡ªå‹•ï¼ˆä¾ç€è¦½å™¨ï¼‰</option>
                <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                <option value="en">English</option>
                <option value="de">Deutsch</option>
            </select>
            <label for="input-thick">åšåº¦ (Âµm)</label>
            <input type="number" id="input-thick" value="300" min="100" max="5000" step="50">
            <label for="input-range">X è»¸è¡Œç¨‹ (Âµm)</label>
            <input type="number" id="input-range" value="2000" min="500" max="10000" step="100">
        </div>
    </aside>
    <div class="main-content">
        <h2 data-i18n="mainTitle">å¹²æ¶‰å¼æ„Ÿæ¸¬å™¨ Demo</h2>
        <p data-i18n="mainDesc">å±•ç¤ºè·é›¢ (Distance) èˆ‡åšåº¦ (Thickness) Peak è®ŠåŒ–é—œä¿‚</p>
        <div id="canvas-container"></div>
        <div class="instructions">
            ğŸ’¡ <b data-i18n="instructionsLabel">æ“ä½œèªªæ˜ï¼š</b> <span data-i18n="instructionsText">è«‹ä½¿ç”¨æ»‘é¼ ã€Œæ‹–æ›³è—è‰²è¡¨é¢ã€ä¾†è§€å¯Ÿä¸‹æ–¹è¨Šè™Ÿè®ŠåŒ–ã€‚</span>
        </div>
    </div>
</div>

<script>
// --- å¤šèªç³» ---
const i18n = {
    'zh-TW': {
        settingsTitle: 'è¨­å®š', langLabel: 'èªè¨€', thickLabel: 'åšåº¦ (Âµm)', rangeLabel: 'X è»¸è¡Œç¨‹ (Âµm)',
        mainTitle: 'å¹²æ¶‰å¼æ„Ÿæ¸¬å™¨ Demo', mainDesc: 'å±•ç¤ºè·é›¢ (Distance) èˆ‡åšåº¦ (Thickness) Peak è®ŠåŒ–é—œä¿‚',
        instructionsLabel: 'æ“ä½œèªªæ˜ï¼š', instructionsText: 'è«‹ä½¿ç”¨æ»‘é¼ ã€Œæ‹–æ›³è—è‰²è¡¨é¢ã€ä¾†è§€å¯Ÿä¸‹æ–¹è¨Šè™Ÿè®ŠåŒ–ã€‚',
        toggleSettings: 'å±•é–‹/æ”¶åˆè¨­å®š',
        physicalSpace: 'ç‰©ç†ç©ºé–“ç¤ºæ„ (Physical Space)', signalPeaks: 'è¨Šè™Ÿå…‰è­œ (Signal Peaks)',
        labelAb: 'a-b (Thickness)', labelAR: 'a-R (Dist)', labelBR: 'b-R'
    },
    'zh-CN': {
        settingsTitle: 'è®¾ç½®', langLabel: 'è¯­è¨€', thickLabel: 'åšåº¦ (Âµm)', rangeLabel: 'X è½´è¡Œç¨‹ (Âµm)',
        mainTitle: 'å¹²æ¶‰å¼ä¼ æ„Ÿå™¨ Demo', mainDesc: 'å±•ç¤ºè·ç¦» (Distance) ä¸åšåº¦ (Thickness) Peak å˜åŒ–å…³ç³»',
        instructionsLabel: 'æ“ä½œè¯´æ˜ï¼š', instructionsText: 'è¯·ä½¿ç”¨æ»‘é¼ ã€Œæ‹–æ›³è“è‰²è¡¨é¢ã€æ¥è§‚å¯Ÿä¸‹æ–¹è®¯å·å˜åŒ–ã€‚',
        toggleSettings: 'å±•å¼€/æ”¶èµ·è®¾ç½®',
        physicalSpace: 'ç‰©ç†ç©ºé—´ç¤ºæ„ (Physical Space)', signalPeaks: 'è®¯å·å…‰è°± (Signal Peaks)',
        labelAb: 'a-b (åšåº¦)', labelAR: 'a-R (è·ç¦»)', labelBR: 'b-R'
    },
    'en': {
        settingsTitle: 'Settings', langLabel: 'Language', thickLabel: 'Thickness (Âµm)', rangeLabel: 'X Range (Âµm)',
        mainTitle: 'Interferometric Sensor Demo', mainDesc: 'Shows relationship between Distance and Thickness peaks',
        instructionsLabel: 'Instructions:', instructionsText: 'Drag the blue surface to observe signal changes below.',
        toggleSettings: 'Expand/Collapse settings',
        physicalSpace: 'Physical Space', signalPeaks: 'Signal Peaks',
        labelAb: 'a-b (Thickness)', labelAR: 'a-R (Dist)', labelBR: 'b-R'
    },
    'de': {
        settingsTitle: 'Einstellungen', langLabel: 'Sprache', thickLabel: 'Dicke (Âµm)', rangeLabel: 'X-Bereich (Âµm)',
        mainTitle: 'Interferometrischer Sensor Demo', mainDesc: 'Zeigt die Beziehung zwischen Distanz- und Dicke-Peaks',
        instructionsLabel: 'Anleitung:', instructionsText: 'Ziehen Sie die blaue FlÃ¤che, um die Signale unten zu beobachten.',
        toggleSettings: 'Einstellungen ein-/ausklappen',
        physicalSpace: 'Physikalischer Raum', signalPeaks: 'Signal-Peaks',
        labelAb: 'a-b (Dicke)', labelAR: 'a-R (Abst.)', labelBR: 'b-R'
    }
};
let currentLang = 'zh-TW';  // å¿«å–ç•¶å‰èªè¨€ï¼Œä¾› canvas draw ä½¿ç”¨
function getLang() {
    const sel = document.getElementById('input-lang');
    if (!sel) return currentLang;
    const v = sel.value;
    if (v === 'auto') {
        const browser = (navigator.language || navigator.userLanguage || 'en').toLowerCase();
        if (browser.startsWith('zh')) return browser.startsWith('zh-cn') ? 'zh-CN' : 'zh-TW';
        if (browser.startsWith('de')) return 'de';
        return 'en';
    }
    return v;
}
function updateCurrentLang() { currentLang = getLang(); }
function t(key) { return (i18n[currentLang] || i18n['zh-TW'])[key] || key; }
function applyI18n() {
    const lang = getLang();
    const L = i18n[lang] || i18n['zh-TW'];
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const k = el.getAttribute('data-i18n');
        if (L[k] !== undefined) el.textContent = L[k];
    });
    document.querySelectorAll('[data-i18n-title]').forEach(el => {
        const k = el.getAttribute('data-i18n-title');
        if (L[k] !== undefined) el.title = L[k];
    });
    const labels = { 'input-thick': 'thickLabel', 'input-range': 'rangeLabel' };
    Object.keys(labels).forEach(id => {
        const lab = document.querySelector(`label[for="${id}"]`);
        if (lab && L[labels[id]]) lab.textContent = L[labels[id]];
    });
    const labLang = document.querySelector('label[for="input-lang"]');
    if (labLang && L.langLabel) labLang.textContent = L.langLabel;
    const h3 = document.querySelector('.settings-panel h3');
    if (h3 && L.settingsTitle) h3.textContent = L.settingsTitle;
}

// --- æ‚¨èª¿æ•´å¾Œçš„æ ¸å¿ƒé‚è¼¯ ---
let rPos = 300;     // åƒè€ƒé¢ R çš„å›ºå®šä½ç½®ï¼ˆè¼ƒä½ï¼‰
let aPos = 280;     // è¡¨é¢ a çš„é è¨­ä½ç½®ï¼ˆèˆ‡åƒè€ƒé¢ç­‰é«˜ï¼ša ç·šèˆ‡ R ç´…ç·šåŒé«˜ï¼‰
let UM_MAX = 2000;      // X è»¸ç¸½å¯¬ï¼ˆÂµmï¼‰ï¼Œå¯ç”±è¼¸å…¥æ¡†ä¿®æ”¹
let THICK_UM = 300;     // a-b åšåº¦ï¼ˆÂµmï¼‰ï¼Œå¯ç”±è¼¸å…¥æ¡†ä¿®æ”¹
let thick = 175;        // åœ–ç¤ºé«˜åº¦ï¼ˆç”± THICK_UMã€UM_MAX æ¨ç®—ï¼‰
const RANGE_COEF = 0.2;   // rangeOffset èˆ‡ aRBase å…±ç”¨ä¿‚æ•¸ï¼ˆaâ‰¥r æ™‚ peak éˆæ•åº¦ = 1+RANGE_COEFï¼‰
const ABOVE_COEF = 1.2;   // a < r æ™‚ peak éˆæ•åº¦ï¼ˆsurface åœ¨åƒè€ƒé¢ä¸Šæ–¹ï¼‰
const THICK_SCALE = 0.5;  // åšåº¦ Âµmâ†’px æ›ç®—ä¿‚æ•¸ï¼ˆå›ºå®šï¼‰
let isDragging = false;
let sensorImg;      // æ„Ÿæ¸¬å™¨æ¢é ­ç¤ºæ„åœ–

function preload() {
    sensorImg = loadImage('sensor-probe.png');
}

function setup() {
    let cnv = createCanvas(560, 720);
    cnv.parent('canvas-container');
    
    // èªè¨€ï¼šé è¨­ä¾ç€è¦½å™¨ï¼Œä¸¦è¼‰å…¥å„²å­˜åå¥½
    const langSel = document.getElementById('input-lang');
    const saved = localStorage.getItem('demo-lang');
    langSel.value = saved || 'auto';
    langSel.addEventListener('change', function() {
        localStorage.setItem('demo-lang', this.value);
        updateCurrentLang();
        applyI18n();
        redraw();
    });
    updateCurrentLang();
    applyI18n();

    // è¼¸å…¥æ¡†å³æ™‚æ›´æ–°åƒæ•¸
    document.getElementById('input-thick').addEventListener('input', updateParams);
    document.getElementById('input-range').addEventListener('input', updateParams);
    updateParams();  // åˆå§‹åŒæ­¥

    // ä¸‰ç·šæŒ‰éˆ•ï¼šå±•é–‹/æ”¶åˆè¨­å®šè¦–çª—
    document.getElementById('toggle-settings').addEventListener('click', function() {
        document.getElementById('settings-panel').classList.toggle('collapsed');
    });
}

function updateParams() {
    let thickInput = parseInt(document.getElementById('input-thick').value, 10);
    let rangeInput = parseInt(document.getElementById('input-range').value, 10);
    if (!isNaN(thickInput) && thickInput >= 100 && thickInput <= 5000) THICK_UM = thickInput;
    if (!isNaN(rangeInput) && rangeInput >= 500 && rangeInput <= 10000) UM_MAX = rangeInput;
    if (THICK_UM > UM_MAX) {
        THICK_UM = UM_MAX;
        document.getElementById('input-thick').value = THICK_UM;  // åŒæ­¥å›è¼¸å…¥æ¡†
    }
    thick = THICK_UM * 500 / UM_MAX * THICK_SCALE;
}

function draw() {
    background(255);
    
    // æ¨™é¡Œèˆ‡ç¶²æ ¼è¼”åŠ©ç·š (å¯é¸)
    drawUI();

    // 1. ç¹ªè£½ä¸Šæ–¹ç¤ºæ„åœ–ï¼ˆSurface å·¦ã€Reference R å³ï¼‰
    drawSensorProbe();
    drawSurface(aPos, thick);
    drawReferenceR(rPos);  // åƒè€ƒé¢å›ºå®šä½ç½®
    
    // 2. ç¹ªè£½ä¸‹æ–¹ Peak åœ–è¡¨
    drawGraph(aPos, thick, rPos);
}

function drawUI() {
    fill(200);
    noStroke();
    textSize(16);
    textAlign(RIGHT);
    text(t('physicalSpace'), 540, 25);
    text(t('signalPeaks'), 540, 510);
}

function drawSensorProbe() {
    if (sensorImg && sensorImg.width > 0) {
        let w = 85, h = 95;
        image(sensorImg, 40, 30, w, h);  // æ„Ÿæ¸¬å™¨æ¢é ­æ–¼åƒè€ƒé¢å·¦å´ï¼Œç¤ºæ„ç”±ä¸Šå¾€ä¸‹é‡æ¸¬
    }
}

function drawReferenceR(y) {
    stroke(255, 0, 0); strokeWeight(3);
    line(345, y, 505, y); // ç´…è‰² R ç·šï¼ˆå³ç§»ï¼Œèˆ‡æ¨™ç±¤æ‹‰é–‹é–“è·ï¼‰
    fill(255, 255, 0, 100); noStroke();
    rect(345, y, 160, 15); // é»ƒè‰²é™°å½±
    fill(0); textAlign(LEFT); text("R (Ref)", 285, y + 12);  // æ¨™ç±¤åœ¨ç·šå·¦å´ï¼Œç•¥å¾€å³
}

function drawSurface(y, t) {
    stroke(0, 100, 200); strokeWeight(2);
    line(55, y, 255, y);         // è¡¨é¢ aï¼ˆå·¦å´å€å¡Šï¼‰
    line(55, y + t, 255, y + t); // è¡¨é¢ b
    fill(0, 100, 200, 30); noStroke();
    rect(55, y, 200, t);         // è—è‰²é™°å½± (2-surface)
    fill(0); textAlign(LEFT); 
    text("a", 38, y + 5); 
    text("b", 38, y + t + 5);
}

function drawGraph(a, thk, r) {
    push();
    translate(0, 670); // åº§æ¨™ç³»ä¸‹ç§»ï¼ˆé…åˆç•«å¸ƒå¢é«˜ï¼‰
    stroke(150); strokeWeight(1);
    line(30, 0, 530, 0);    // X è»¸
    line(30, 0, 30, -150);  // Y è»¸
    
    // X è»¸åˆ»åº¦ 0~UM_MAX Âµmï¼ˆ30~530 px å°æ‡‰ï¼‰
    const xMin = 30, xMax = 530;
    let tickStep = Math.max(100, Math.round(UM_MAX / 4));
    for (let um = 0; um <= UM_MAX; um += tickStep) {
        let px = xMin + (um / UM_MAX) * (xMax - xMin);
        line(px, 0, px, 5);
        fill(100); noStroke(); textAlign(CENTER); textSize(10);
        text(um + "Âµm", px, 18);
    }
    
    // diagram è·é›¢ï¼ˆpxï¼‰ï¼šthk ä»£è¡¨åšåº¦ï¼Œè½‰æˆ graph åº§æ¨™éœ€ * (thickPx/thk)
    let thickPx = THICK_UM * 500 / UM_MAX;  // ç‰©ç†åšåº¦ 300Âµm å°æ‡‰çš„ graph px
    let scaleToGraph = thickPx / thk;       // diagram px â†’ graph pxï¼ˆç¶­æŒçµæœ=300Âµmï¼‰
    
    let distAR = a - r;        // a åˆ° R çš„è·é›¢ï¼ˆdiagram pxï¼‰
    let distBR = (a + thk) - r; // b åˆ° R çš„è·é›¢ï¼ˆdiagram pxï¼‰
    let distAR_g = distAR * scaleToGraph;   // è½‰æˆ graph åº§æ¨™ï¼ˆç‰©ç† Âµm å°æ‡‰ï¼‰
    let distBR_g = distBR * scaleToGraph;
    
    let rangeOffset = (a - 125) * RANGE_COEF;  // æ¨£å“æ„ˆä¸‹æ–¹ï¼Œpeak æ„ˆå¾€å³
    let aRBase = 30 - (r - 125) * RANGE_COEF;  // a=r æ™‚ peak å°é½Š x=30
    
    // a-R: ç”¨ distAR_g ç¶­æŒ X è»¸ Âµm åˆ»åº¦ä¸è®Š
    let aRPos = (a >= r)
        ? distAR_g + aRBase + rangeOffset
        : aRBase + rangeOffset + ABOVE_COEF * (r - a) * scaleToGraph;
    
    // b-R: peak é–“è·å›ºå®šç‚º thickPxï¼ˆç‰©ç† 300Âµmï¼‰ï¼Œèˆ‡ THICK_SCALE ç„¡é—œ
    let bothBelow = (a >= r && distBR >= 0);  // aã€b éƒ½åœ¨ R ä¸‹æ–¹
    let bothAbove = (a < r && distBR < 0);   // aã€b éƒ½åœ¨ R ä¸Šæ–¹
    let bRPos;
    if (bothBelow) {
        bRPos = aRPos + thickPx;  // b è¼ƒé ï¼Œé–“è·=300Âµm
    } else if (bothAbove) {
        bRPos = aRPos - thickPx;  // a è¼ƒé ï¼Œé–“è·=300Âµm
    } else {
        let bRBase = aRBase + thk * RANGE_COEF;  // b=r æ™‚å°é½Š 0 è»¸ï¼ˆèˆ‡ rangeOffset çš„ thk æŠµéŠ·ï¼‰
        if (distBR >= 0) {
            let origB = distBR_g + bRBase + rangeOffset;
            bRPos = origB - distBR_g * RANGE_COEF;
        } else {
            bRPos = bRBase + rangeOffset + (r - (a + thk)) * scaleToGraph;
        }
    }
    
    // å°‡ pixel è½‰æ›ç‚º Âµmï¼ˆ30~530 px å°æ‡‰ 0~2000 Âµmï¼‰
    let toUm = (px) => Math.round((px - 30) * UM_MAX / 500);
    let toPx = (um) => 30 + um * 500 / UM_MAX;
    
    // a-b peak å›ºå®šæ–¼ 1000 Âµmï¼ˆåšåº¦å€¼ï¼‰
    let abPos = toPx(THICK_UM);
    drawPeak(abPos, 120, t('labelAb'), color(0, 102, 204), THICK_UM);
    drawPeak(aRPos, 120, t('labelAR'), color(255, 50, 50), toUm(aRPos));
    drawPeak(bRPos, 80, t('labelBR'), color(100), toUm(bRPos));
    pop();
}

function drawPeak(x, h, label, clr, umValue) {
    noFill(); stroke(clr); strokeWeight(2);
    beginShape();
    for (let i = -15; i <= 15; i++) {
        // é«˜æ–¯å‡½æ•¸æ¨¡æ“¬å¹³æ»‘ Peakï¼ˆsigma=4 æ§åˆ¶å¯¬åº¦ï¼Œç¯„åœ Â±15ï¼‰
        let y = -h * exp(-sq(i) / (2 * sq(4))); 
        vertex(x + i, y);
    }
    endShape();
    fill(clr); noStroke(); textAlign(CENTER); textSize(11);
    if (umValue !== undefined) {
        text(umValue + " Âµm", x, -h - 8);  // æ•¸å€¼é¡¯ç¤ºåœ¨ peak ä¸Šæ–¹
    }
    text(label, x, 20);
}

// æ»‘é¼ äº’å‹•é‚è¼¯
function mouseDragged() {
    // å¢åŠ æ„Ÿæ‡‰ç¯„åœï¼Œè®“æ‹–æ›³æ›´éˆæ•
    if (mouseY > aPos - 30 && mouseY < aPos + thick + 30) {
        aPos = mouseY - thick/2;
        // é™åˆ¶ç§»å‹•ç¯„åœé¿å…è¶…å‡ºç•«å¸ƒ
        aPos = constrain(aPos, 125, 450);  // ä¸Šé™ 125 = sensor ä¸‹ç·£ï¼Œä¸‹é™æ“´å±• 
    }
}
</script>

</body>
</html>